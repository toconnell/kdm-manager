<!-- top nav - DEPRECATED -->
<div id="topNavBar" class="campaign_summary_gradient">
    <button
        id="floatingRefreshButton"
        class="clickable kd_yellow font_large circular_button"
        ng-if="settlement.sheet !== undefined"
        ng-click="
            showFullPageLoader();
    		initializeSettlement('campaignSummary','$api_url','$settlement_id');
        "
    >
        &#8634;
    </button>
</div>

<script
    src="/js/campaignSummary.js?v=$application_version"
    ng-init="setSessionVars('$user_login','$current_session')"
>
</script>

<div
    id="campaignSummaryContainer"
    ng-controller="campaignSummaryController"
    ng-init="
        showFullPageLoader();
        initializeSettlement('campaignSummary','$api_url','$settlement_id');
    "
>

    <!-- once we get the settlement, init the user -->
    <span
        class="hidden"
        ng-if="settlement != undefined"
        ng-init="initializeUser('$user_id')"
    ></span>
  
    <!-- now start the left/right panels -->
    <div class="campaign_summary_panels_container">

        <div class="campaign_summary_left_panel"> <!--left panel container -->

            <div>
                <h1
                id="campaignSummarySettlementName"
                class="settlement_name"
                >
                    {{settlement.sheet.name}}
                </h1>

                <p
                    id="campaignSummaryCampaignType"
                    class="campaign_type"
                >
                    {{settlement.game_assets.campaign.name}}
                </p>

                <h1
                    ng-if="settlement.sheet.abandoned"
                    class="settlement_abandoned_stamp"
                >       
                    ABANDONED
                </h1>
            </div>

            <div class="campaign_summary_headline_blocks_container" ng-if="settlement.sheet != undefined">
                <div class="headline_block">
                    <p class="headline_block_caption">Lantern Year</p>
                    <section class="shape-section">
                        <div class="diamond">
                            <div class="diamond_inner">{{settlement.sheet.lantern_year}}</div>
                        </div>
                    </section>
                </div>

                <div class="headline_block">
                    <p class="headline_block_caption">Survival Limit</p>
                    <section class="shape-section">
                        <div class="diamond">
                            <div class="diamond_inner">{{settlement.sheet.survival_limit}}</div>
                        </div>
                    </section>
                </div>

                <div class="headline_block">
                    <p class="headline_block_caption">Population</p>
                    <section class="shape-section">
                        <div class="diamond">
                            <div class="diamond_inner">
                                {{settlement.sheet.population}}
                            </div>
                        </div>
                    </section>
                    <div class="headline_block_subtitle">
                        <span class="headline_pop_by_sex"><b>M: </b>{{settlement.sheet.population_by_sex.M}}</span>
                        <span class="headline_pop_by_sex"><b>F: </b>{{settlement.sheet.population_by_sex.F}}</span>
                    </div>
                </div>

                <div class="headline_block">
                    <p class="headline_block_caption">Death Count</p>
                    <section class="shape-section">
                        <div class="diamond">
                            <div class="diamond_inner">{{settlement.sheet.death_count}}</div>
                        </div>
                    </section>
                </div>

            </div><!-- campaign_summary_headline_blocks_container -->


            <!-- no survivors pink error warning box -->
            <div
                id="campaignSummaryNoSurvivorsError"
                ng-if="settlement.user_assets.survivors.length == 0"
                class="kd pink rulebook_warning"
            >
                <span>
                    <b>{{settlement.sheet.name}}</b> does not have any
                    survivors!
                    Use the navigation menu controls in the upper left to add
                    new survivors.
                </span>
            </div>



            <!-- 
                    survivors app-let/mini-app

            The 'campaign_summary_survivors_container' div below contains
            repeaters for each survivor group ('Departing', 'The Dead', etc.)

            Within that are the individual survivor buttons that open the
            'quickview' modals, as well as the modals themselves.

            -->

            <div
                class="campaign_summary_survivors_container"
                ng-if="settlement.user_assets.survivors.length >= 1"
                ng-controller="survivorManagementController"
            >

                <h2>- Survivors - </h2>
	            <div
	                class="ng_fade kd_sheet_ui_row_tip"
                	ng-if="user.user.preferences.show_ui_tips"
	            >
                	<p>Tap or click a survivor for management options.</p>
    	        </div>

                <center
                    id="waitingForSurvivors"
                    class="ng_fade hidden"
                    ng-if="settlement.user_assets.survivor_groups.length > 1"
                >
                    <img src="/media/loading_io.gif"/>
                    <p class="subtitle">
                        Summarizing {{settlement.user_assets.survivors.length}} survivors...
                    </p>
                </center>

                <div
                    class="campaign_summary_survivors_group"
                    ng-repeat="group in settlement.user_assets.survivor_groups"
                    ng-if="group.survivors.length >= 1 && user != undefined"
                    ng-init="
                        containerID = group.handle + '_container';
                    "
                >
                    <span ng-init="fadeSurvivorGroupsLoader()"></span>

                    <h3
                        title="group.title_tip"
                        ng-click="rollUp(containerID)"
                        class="clickable {{group.handle}}"
                    >
                        {{group.name}} ({{group.survivors.length}})
			            <span
			                class="roll_content_arrow"
			                ng-class="{'open': ngRolledUp[containerID] === false}"
			            >
							&#x25BC;
						</span>
                    </h3>


                    <div
                        id="{{containerID}}"
                        class="roll_down_container"
                    >

                        <!-- control starting state -->
                        <span
                            ng-if="containerID !== undefined"
    		    			ng-init="rollDown(containerID)"
                        ></span>
                        <span
                            ng-if="containerID === 'the_dead_container'"
    		    			ng-init="rollUp('the_dead_container')"
                        ></span>

                        <div
                            class="campaign_summary_survivor_container {{group.handle}}"
                            ng-repeat="s in group.survivors"
                            ng-init="
                                initSurvivorCard(s);
                                survivorQuickviewControllerId = s.sheet._id.$oid + 'QuickviewControls'
                            "
                        >

                            <!-- the clickable survivor button starts here -->

                            <button
                                class="campaign_summary_survivor {{group.handle}}"
                                ng-disabled="!s.meta.manageable"
                                ng-click="ngShow(survivorQuickviewControllerId)"
                                ng-class="{
                                    disabled: s.meta.manageable == false,
                                    survivor_sheet_gradient: s.meta.manageable == true,
                                    dead_survivor_gradient: s.sheet.dead == true,
                                    affinity_red: s.sheet.savior == 'red' && s.sheet.dead == undefined,
                                    affinity_green: s.sheet.savior == 'green' && s.sheet.dead == undefined,
                                    affinity_blue: s.sheet.savior == 'blue' && s.sheet.dead == undefined,
                                }"
                                style='{{settlement.survivor_color_schemes[s.sheet.color_scheme].style_string}}'
                            >

                                <div
                                    ng-if="s.meta.returning_survivor == true && s.sheet.dead != true"
                                    class="campaign_summary_survivor_returning_flash"
                                >
                                    Returning Survivor
                                </div>

                                <div class="campaign_summary_survivor_avatar_and_summary">
                                    <div class="avatar">
                                        <span
                                            class="ng_fade death_x special_showdown"
                                            ng-if="
												s.sheet.dead === true &&
												ngRolledUp[containerID] === false
											"
                                        >
                                            X
                                        </span>
                                        <img
                                            class="campaign_summary_avatar"
                                            ng-if="s.sheet.avatar != undefined"
                                            ng-src="{{api_url}}avatar/get/{{s.sheet.avatar.$oid}}"
                                        />
                                        <img
                                            class="campaign_summary_avatar"
                                            ng-if="s.sheet.avatar == undefined"
                                            ng-src="/media/default_avatar_{{s.sheet.effective_sex}}.png"
                                        />
                                    </div>

                                    <div class="summary">

                                        <div
                                            class="campaign_summary_survivor_button_bleeding_tokens_container"
                                            ng-if="s.sheet.bleeding_tokens > 0"
                                        >
                                            <span
                                                ng-repeat="token in range(s.sheet.bleeding_tokens)"
                                            >
                                                &#129656;
                                            </span>
                                        </div>

                                        <div
                                            class="font_large name"
                                            ng-class="{maroon_text: s.sheet.dead == true}"
                                        >
                                            <b>{{s.sheet.name}}</b> [{{s.sheet.effective_sex}}]
                                        </div>

                                        <div class="epithets">
                                            <span ng-repeat="e in s.sheet.epithets">
                                                {{settlement.game_assets.epithets[e].name}}{{$last ? '' : ', '}}
                                            </span>
                                        </div>


                                        <div class="attr_holder">
                                            <div class="attr maroon_text" ng-if="s.sheet.dead == true">
                                                <b>Died in Lantern Year {{s.sheet.died_in}} </b>
                                            </div>
                                            <div class="attr COD maroon_text" ng-if="s.sheet.dead == true">
                                                Cause of death: {{s.sheet.cause_of_death}}
                                            </div>
                                            <div class="attr">Hunt XP: {{s.sheet.hunt_xp}}</div>
                                            <div class="attr">Survival: {{s.sheet.survival}}</div>
                                            <div class="attr" ng-class="{maroon_text: s.sheet.Insanity >= 3}">Insanity: {{s.sheet.Insanity}}</div>
                                            <div class="attr">Courage: {{s.sheet.Courage}}</div>
                                            <div class="attr">Understanding: {{s.sheet.Understanding}}</div>
                                            <div 
                                                class="attr"
                                                ng-if="s.sheet.weapon_proficiency_type != undefined"
                                            >
                                                <b>{{settlement.game_assets.weapon_proficiency_types[
                                                    s.sheet.weapon_proficiency_type
                                                ].name}}</b> proficiency:
                                                {{s.sheet['Weapon Proficiency']}}
                                            </div>
                                        </div> <!-- attr_holder -->

                                        <div class="campaign_summary_survivor_affinities_container">
                                            <div
                                                class="kd_sheet_ui_box affinity_red"
                                                ng-repeat="cube in range(s.sheet.affinities.red)"
                                            >
                                            </div>
                                            <div
                                                class="kd_sheet_ui_box affinity_green"
                                                ng-repeat="cube in range(s.sheet.affinities.green)"
                                            >
                                            </div>
                                            <div
                                                class="kd_sheet_ui_box affinity_blue"
                                                ng-repeat="cube in range(s.sheet.affinities.blue)"
                                            >
                                            </div>
                                        </div>
                                        
                                    </div> <!-- summary -->

                                </div> <!-- avatar_and_summary -->

                                <div class="campaign_summary_survivor_tags_container">
                                    <div
                                        class="survivor_tag fighting_arts_tag"
                                        ng-repeat="fa in s.sheet.fighting_arts track by $index"
                                    >
                                        <span>
                                            {{settlement.game_assets.fighting_arts[fa].name}}
                                        </span>
                                    </div>
                                </div>
                                <div class="campaign_summary_survivor_tags_container">
                                    <div
                                        class="survivor_tag disorders_tag"
                                        ng-repeat="d in s.sheet.disorders track by $index"
                                    >
                                        <span>
                                            {{settlement.game_assets.disorders[d].name}}
                                        </span>
                                    </div>
                                </div>
                                <div class="campaign_summary_survivor_tags_container">
                                    <div
                                        class="survivor_tag ai_tag {{settlement.game_assets.abilities_and_impairments[ai].sub_type}}"
                                        ng-repeat="ai in s.sheet.abilities_and_impairments track by $index"
                                    >
                                        <span>
                                            {{settlement.game_assets.abilities_and_impairments[ai].name}}
                                        </span>
                                    </div>
                                </div>

                                <div class="campaign_summary_survivor_tags_container">
                                    <div
                                        class="survivor_tag status_tag"
                                        ng-repeat="flag in settlement.survivor_status_flags"
                                        ng-if="s.sheet[flag.handle] == true"
                                    >
                                        <span>
                                            {{flag.name}}
                                        </span>
                                    </div>
                                </div>

                                <div
                                    ng-if="s.sheet.constellation != undefined"
                                    class="campaign_summary_survivor_constellation dragon_king"
                                >
                                    {{s.sheet.constellation}}
                                </div>

                            </button> <!-- end of the clickable survivor button -->


                            <!-- 

                                survivor modal starts here! this is the whole
                                mini-form/quickview thing

                            -->

                            <div
                                id="{{survivorQuickviewControllerId}}"
                                ng-if="ngVisible[survivorQuickviewControllerId]"
                                class="modal-black hidden"
                            >
                                <div
                                    class="kd_sheet_ui_outer_ring_container"
                                    style='{{settlement.survivor_color_schemes[s.sheet.color_scheme].style_string}}'
                                    ng-click="ngHide(survivorQuickviewControllerId)"
                                >
                                    <div
                                        class="ng_fade kd_sheet_ui_inner_ring_container survivor_quickview_container"
                                        ng-click="$event.stopPropagation()"
                                        ng-init="
                                            survivalBoxID = 'survivalControl' + s.sheet._id.$oid;
                                            bleedBoxID = 'bleedControl' + s.sheet._id.$oid;
                                            brainBoxID = 'brainControl' + s.sheet._id.$oid;
                                            huntXPBoxID = 'huntXPControl' + s.sheet._id.$oid;
                                            weaponProficiencyBoxID = 'weaponProficiencyControl' + s.sheet._id.$oid;
                                            courageBoxID = 'courageControl' + s.sheet._id.$oid;
                                            understandingBoxID = 'understandingControl' + s.sheet._id.$oid;
                                            attrib_list = ['Movement','Accuracy','Strength','Evasion','Luck','Speed'];
                                        "
                                    >
                                        <div class="columns">

                                            <div id="survivorQuickviewLeftColumn">

                                                <div class="quickview_survivor_name_and_sex_bar">
                                                    <span class="font_large quickview_name_box">
                                                        {{s.sheet.name}}
                                                    </span>
                                                    <div class="font_small quickview_sex_box">
                                                        <div>M</div>
                                                        <div class="kd_sheet_ui_box" ng-class="{checked: s.sheet.effective_sex == 'M'}"></div>
                                                        <div>F</div>
                                                        <div class="kd_sheet_ui_box" ng-class="{checked: s.sheet.effective_sex == 'F'}"></div>
                                                    </div>
                                                </div> <!-- name and sex -->

                                                <div
                                                    class="quickview_survival_container border_box"
                                                >

                                                    <div
                                                        class="survival_box_number_container clickable"
                                                        ng-click="rollUp(survivalBoxID)"
                                                    >
                                                        <input
                                                            disabled
                                                            class="survival_box_number"
                                                            type="number"
                                                            ng-model="s.sheet.survival"
                                                            min="0"
                                                        />
                                                    </div>

                                                    <div class="survival_box_title_and_lock">
                                                        <div
                                                            class="clickable font_large survival_box_title"
                                                            ng-click="rollUp(survivalBoxID)"
                                                        >
                                                            Survival
                                                        </div>
                                                        <div
                                                            class="survival_box_lock clickable"
                                                            ng-click="toggleSurvivorFlag(s, 'cannot_spend_survival')"
                                                        >
                                                            <div
                                                                class="kd_sheet_ui_box"
                                                                ng-class="{checked: s.sheet.cannot_spend_survival == true}"
                                                            ></div>
                                                            <div class="font_small">
                                                                &#x1f512; Cannot spend survival.
                                                            </div>
                                                        </div>
                                                    </div>

                                                    <div
                                                        class="survival_box_survival_actions_container"
                                                        ng-click="rollUp(survivalBoxID)"
                                                    >
                                                        <div
                                                            class="survival_box_survival_action_item"
                                                            ng-repeat="sa in s.survival_actions"
                                                        >
                                                            <div
                                                                class="kd_sheet_ui_box small"
                                                                ng-class="{checked: sa.available == true}"
                                                            ></div>
                                                            <span class="font_small sa_name">{{sa.name}}</span>
                                                        </div>
                                                    </div>
                                                </div> <!-- quickview_survival_container -->

                                                <div
                                                    id="{{survivalBoxID}}"
                                                    class="kd_sheet_ui_roll_down rolled_up"
                                                >
                                                    <div class="kd_sheet_ui_roll_down_controls">

                                                        <div
                                                            class="kd_sheet_ui_row_tip"
                                                            ng-if="settlement.sheet.enforce_survival_limit == true"
                                                        >
                                                            {{settlement.sheet.name}} Survival Limit is <b>{{settlement.sheet.survival_limit}}</b>!
                                                        </div>

                                                        <div class="kd_sheet_ui_number_tumbler">
                                                            <button
                                                                class="kd_kickstarter_button"
                                                                ng-disabled="s.sheet.can_gain_survival === false"
                                                                ng-click="s.sheet.survival = s.sheet.survival + 1"
                                                            >
                                                                &#x25B2;
                                                            </button>
                                                            <button
                                                                ng-disabled="s.sheet.survival < 1"
                                                                class="kd_kickstarter_button"
                                                                ng-click="s.sheet.survival = s.sheet.survival - 1"
                                                            >
                                                                &#x25BC;
                                                            </button>
                                                            <button
                                                                class="kd_kickstarter_button kd_blue"
                                                                ng-click="
                                                                    setSurvivorAttribute(s, 'survival');
                                                                    rollUp(survivalBoxID)
                                                                "
                                                            >
                                                                Save Changes
                                                            </button>
                                                        </div> <!-- number tumbler -->
                                                    </div><!-- roll_down_controls -->
                                                </div><!-- survival box -->

                                                <div
                                                    class="attributes_container border_box"
                                                >
                                                    <div
                                                        ng-repeat="A in attrib_list"
                                                        class="attribute_box clickable {{A}}"
                                                        ng-class="{last: $last}"
                                                        ng-click="rollUp(A + 'BoxID' + s.sheet._id.$oid)"
                                                    >
                                                        <input
                                                            disabled
                                                            class="attribute_box_number"
                                                            type="number"
                                                            ng-value="s.sheet[A] + s.sheet.attribute_detail[A].tokens + s.sheet.attribute_detail[A].gear"
                                                            ng-class="{
                                                                maroon_text: s.sheet[A] + s.sheet.attribute_detail[A].tokens + s.sheet.attribute_detail[A].gear < s.sheet[A],
                                                                green_text: s.sheet[A] + s.sheet.attribute_detail[A].tokens + s.sheet.attribute_detail[A].gear > s.sheet[A],
                                                            };"
                                                        />
                                                        <span class="font_small">
                                                            {{A}}
                                                        </span>
                                                    </div> <!-- attributes repeater -->
                                                </div> <!-- attributes container -->

                                                <!-- attrib_list repeater -->
                                                <div
                                                    ng-repeat="A in attrib_list"
                                                    id="{{A}}BoxID{{s.sheet._id.$oid}}"
                                                    class="kd_sheet_ui_roll_down rolled_up"
                                                >
                                                    <div
                                                        class="
                                                            kd_sheet_ui_roll_down_controls
                                                            quickview_attribute_tumblers_container {{A}}
                                                        "
                                                    >

                                                        <div class="vertical_tumbler_container">
                                                            Base
                                                            <button ng-click="s.sheet[A] = s.sheet[A] + 1">
                                                                &#x25B2;
                                                            </button>
                                                            <input type="number" ng-model="s.sheet[A]" />
                                                            <button ng-click="s.sheet[A] = s.sheet[A] - 1">
                                                                &#x25BC;
                                                            </button>
                                                        </div>

                                                        <div class="vertical_tumbler_container">
                                                            Gear
                                                            <button
                                                                ng-click="
                                                                    s.sheet.attribute_detail[A].gear = s.sheet.attribute_detail[A].gear + 1
                                                                "
                                                            >
                                                                &#x25B2;
                                                            </button>
                                                            <input type="number" ng-model="s.sheet.attribute_detail[A].gear" />
                                                            <button ng-click="s.sheet.attribute_detail[A].gear = s.sheet.attribute_detail[A].gear - 1">
                                                                &#x25BC;
                                                            </button>
                                                        </div>

                                                        <div class="vertical_tumbler_container">
                                                            Tokens
                                                            <button ng-click="s.sheet.attribute_detail[A].tokens = s.sheet.attribute_detail[A].tokens + 1">
                                                                &#x25B2;
                                                            </button>
                                                            <input type="number" ng-model="s.sheet.attribute_detail[A].tokens" />
                                                            <button ng-click="s.sheet.attribute_detail[A].tokens = s.sheet.attribute_detail[A].tokens - 1">
                                                                &#x25BC;
                                                            </button>
                                                        </div>
                                                    </div>

                                                    <button
                                                        class="kd_kickstarter_button kd_blue"
                                                        ng-click="
                                                            rollUp(A + 'BoxID' + s.sheet._id.$oid);
                                                            setSurvivorPrimaryAttributes(s, A)
                                                        "
                                                    >
                                                        Save {{A}}
                                                    </button>
                                                </div> <!-- attrib_list repeater -->


                                                <!-- 

                                                    hit box controls start now !! 

                                                -->

                                                <div
                                                    class="hitbox_container brain quickview_brain_container"
                                                    ng-class="{'insane': s.sheet.Insanity >= 3}"
                                                >

                                                    <div
                                                        class="
                                                            font_large
                                                            hitbox_shield_container
                                                            brain
                                                        "
                                                        ng-click="rollUp(brainBoxID)"
                                                    >
                                                        <input
                                                            disabled
                                                            class="hitbox_shield brain clickable"
                                                            type="number"
                                                            ng-model="s.sheet.Insanity"
                                                            min="0"
                                                            ng-class="{'insane': s.sheet.Insanity >= 3}"
                                                        />
                                                        <span
                                                            class="font_small"
                                                        >
                                                            Insanity
                                                        </span>
                                                    </div>

                                                    <div
                                                        class="hitbox_detail brain clickable"
                                                        ng-click="rollUp(brainBoxID)"
                                                    >
                                                        <div class="title">Brain</div>
                                                        <div
                                                            class="font_small tip"
                                                            ng-class="{maroon_text: s.sheet.Insanity >= 3}"
                                                        >
                                                            If your insanity is 3+, you are <b>insane</b>.
                                                        </div>
                                                    </div>

                                                    <div class="hitbox_boxes_container brain">
                                                        <div
                                                            class="clickable damage_box"
                                                            ng-class="{
                                                                'checked': s.sheet.brain_damage_light != undefined,
                                                                'kd_red_box': s.sheet.brain_damage_light && s.sheet.Insanity >= 3,
                                                            }"
                                                            ng-click="toggleDamage(s, 'brain_damage_light');"
                                                         /></div>
                                                    </div>
                                                </div>

                                                <div
                                                    id="{{brainBoxID}}"
                                                    class="kd_sheet_ui_roll_down brain rolled_up"
                                                >
                                                    <div class="kd_sheet_ui_roll_down_controls">
                                                        <div class="kd_sheet_ui_number_tumbler">
                                                            <button
                                                                class="kd_kickstarter_button"
                                                                ng-click="s.sheet.Insanity = s.sheet.Insanity + 1"
                                                            >
                                                                &#x25B2;
                                                            </button>
                                                            <button
                                                                class="kd_kickstarter_button"
                                                                ng-click="s.sheet.Insanity = s.sheet.Insanity - 1"
                                                            >
                                                                &#x25BC;
                                                            </button>
                                                            <button
                                                                class="kd_kickstarter_button kd_blue"
                                                                ng-click="setSurvivorAttribute(s, 'Insanity'); rollUp(brainBoxID)"
                                                            >
                                                                Save Changes
                                                            </button>
                                                        </div> <!-- number tumbler -->
                                                    </div>
                                                </div>

            <!-- bleeding_tokens -->
            <div
                class="hitbox_container"
                title="Bleeding Tokens"
            >
                <div
                    class="clickable bleeding_token_container"
					ng-click="rollUp(bleedBoxID)"
                >
					<div
                    	ng-repeat="token_value in [1,2,3,4,5]"
						class="kd bleeding_token"
						ng-class="{
							'active': token_value <= s.sheet.bleeding_tokens,
						}"
					>
					</div>
					<div
						ng-if="s.sheet.bleeding_tokens >= token_value"
                    	ng-repeat="token_value in [6,7]"
						class="ng_fade kd bleeding_token active"
					>
					</div>
                </div>
			</div>
            <div
                id="{{bleedBoxID}}"
                class="kd_sheet_ui_roll_down rolled_up"
            >
                <div class="kd_sheet_ui_roll_down_controls">
                    <div class="kd_sheet_ui_number_tumbler">
                        <button
							ng-disabled="s.sheet.bleeding_tokens === 7"
                            class="kd_kickstarter_button"
                            ng-click="s.sheet.bleeding_tokens = s.sheet.bleeding_tokens + 1"
                        >
                            &#x25B2;
                        </button>
                        <button
							ng-disabled="s.sheet.bleeding_tokens === 0"
                            class="kd_kickstarter_button"
                            ng-click="s.sheet.bleeding_tokens = s.sheet.bleeding_tokens - 1"
                        >
                            &#x25BC;
                        </button>
                        <button
                            class="kd_kickstarter_button kd_blue"
                            ng-click="
                                setBleedingTokens(s);
                                rollUp(bleedBoxID)
                            "
                        >
                            Save Bleeding Tokens
                        </button>
                    </div> <!-- number tumbler -->
                </div><!-- roll_down_controls -->
            </div><!-- roll_down container + loc box ID -->
            <!-- bleeding tokens -->


            <!-- hit location repeater! -->
            <div
                class="hit_location_repeater"
                ng-if="s.sheet._id.$oid !== undefined"
                ng-repeat="location in [
                    {name: 'Head', glyph: 'b', dmg: ['heavy']},
                    {name: 'Arms', glyph: 'd', dmg: ['light', 'heavy']},
                    {name: 'Body', glyph: 'c', dmg: ['light', 'heavy']},
                    {name: 'Waist', glyph: 'e', dmg: ['light', 'heavy']},
                    {name: 'Legs', glyph: 'f', dmg: ['light', 'heavy']},
                ]"
                ng-init="
                    sheetOID = s.sheet._id.$oid;
                    ctrlBoxID = location.name.toLowerCase() + 'Box' + sheetOID;
                "
            >

                <div 
                    class="hitbox_container"
                >
                    <div
                        class="font_large hitbox_shield_container"
                        ng-click="rollUp(ctrlBoxID)"
                    >
                        <input
                            disabled
                            class="hitbox_shield clickable"
                            type="number"
                            min="0"
                            ng-model="s.sheet[location.name]"
                        />
                    </div>

                    <div
                        class="hitbox_detail"
                        ng-click="rollUp(ctrlBoxID)"
                    >
                        <div class="title">
                            <font class="kdm_font_hit_locations">
                                {{location.glyph}}
                            </font> 
                            {{location.name}}
                        </div>
                        <div class="font_small tip">
                            <div class="kd_sheet_ui_box small checked"></div> Heavy Injury: Knocked Down.
                        </div>
                    </div>

                    <div class="hitbox_boxes_container">
                        <div
                            ng-repeat="dmgType in location.dmg"
                            ng-init="toggleName = location.name.toLowerCase() + '_damage_' + dmgType"
                            ng-class="
                                {checked: s.sheet[toggleName] !== undefined}
                           "
                            ng-click="toggleDamage(s, toggleName);"
                            class="clickable damage_box {{dmgType}}"
                         />
                         </div> 
                    </div>

                </div> <!-- hitbox_container -->

                <div
                    id="{{ctrlBoxID}}"
                    class="kd_sheet_ui_roll_down rolled_up"
                >
                    <div class="kd_sheet_ui_roll_down_controls">
                        <div class="kd_sheet_ui_number_tumbler">
                            <button
                                class="kd_kickstarter_button"
                                ng-click="s.sheet[location.name] = s.sheet[location.name] + 1"
                            >
                                &#x25B2;
                            </button>
                            <button
                                class="kd_kickstarter_button"
                                ng-click="s.sheet[location.name] = s.sheet[location.name] - 1"
                            >
                                &#x25BC;
                            </button>
                            <button
                                class="kd_kickstarter_button kd_blue"
                                ng-click="
                                    setSurvivorAttribute(s, location.name);
                                    rollUp(ctrlBoxID)
                                "
                            >
                                Save Changes
                            </button>
                        </div> <!-- number tumbler -->
                    </div><!-- roll_down_controls -->
                </div><!-- roll_down container + loc box ID -->
            </div> <!-- quickview location repeater -->

        </div><!-- left_column -->


    <!-- survivor quickview column split! -->


        <div class="right_column">

            <!-- hunt xp-->
            <div
                class="quickview_secondary_container hunt_xp clickable"
                ng-click="rollUp(huntXPBoxID)"
            >
                Hunt XP
                <div
                    class="secondary_attrib_box_row hunt_xp"
                    ng-init="huntXPBoxes = [1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16]"
                >
                    <div
                        class="kd_sheet_ui_box"
                        ng-repeat = "b in huntXPBoxes"
                        ng-class="{
                            checked: s.sheet.hunt_xp >= b,
                            heavy: [2,6,10,15,16].indexOf(b) != -1,
                        }"
                    >
                    </div>
                </div>
            </div>

            <div
                id="{{huntXPBoxID}}"
                class="kd_sheet_ui_roll_down rolled_up"
            >
                <div class="kd_sheet_ui_roll_down_controls">
                    <div class="kd_sheet_ui_number_tumbler">
                        <button
                            class="kd_kickstarter_button"
                            ng-click="s.sheet.hunt_xp = s.sheet.hunt_xp + 1"
                        >
                            &#x25B2;
                        </button>
                        <button
                            class="kd_kickstarter_button"
                            ng-click="s.sheet.hunt_xp = s.sheet.hunt_xp - 1"
                        >
                            &#x25BC;
                        </button>
                        <button
                            class="kd_kickstarter_button kd_blue"
                            ng-click="
                                setSurvivorAttribute(s, 'hunt_xp');
                                rollUp(huntXPBoxID)
                            "
                        >
                            Save Hunt XP
                        </button>
                    </div> <!-- number tumbler -->
                </div>
            </div>
            <!-- hunt xp-->


            <!-- weapon prof -->
            <div
                class="quickview_secondary_container weapon_proficiency clickable border_box"
                ng-click="rollUp(weaponProficiencyBoxID)"
            >

                 Weapon Proficiency

                 <div
                     class="secondary_attrib_box_row weapon_proficiency"
                 >

                     <div class="weapon_proficiency_type">
                         <b class="font_small">Type:&nbsp;</b>
                         <div
                            class="null_weapon_proficiency"
                            ng-if="s.sheet.weapon_proficiency_type == undefined"
                         ></div>

                         <span
                            ng-if="s.sheet.weapon_proficiency_type != undefined"
                         >
                             {{settlement.game_assets.weapon_proficiency_types[s.sheet.weapon_proficiency_type].name}}
                         </span>
                     </div>

                     <div class="weapon_proficiency_boxes">
                         <div
                             class="kd_sheet_ui_box"
                             ng-repeat = "b in [1,2,3,4,5,6,7,8]"
                             ng-class="{
                                 checked: s.sheet['Weapon Proficiency'] >= b,
                                 heavy: [3,8].indexOf(b) != -1,
                             }"
                         >
                         </div>
                     </div>

                 </div>
                 <div
                     class="kd_sheet_ui_row_tip"
                     ng-repeat="ai_handle in s.sheet.abilities_and_impairments track by $index"
                     ng-if="settlement.game_assets.weapon_specializations[ai_handle] != undefined"
                 >
                     <b>{{settlement.game_assets.weapon_specializations[ai_handle].name}}:</b>
                     <span
                         ng-bind-html="settlement.game_assets.weapon_specializations[ai_handle].desc|trustedHTML"
                     >
                     </span>
                 </div>
             </div>

             <div
                 id="{{weaponProficiencyBoxID}}"
                 class="kd_sheet_ui_roll_down rolled_up"
             >
                 <div class="kd_sheet_ui_roll_down_controls">

                     <div
                         class="kd_sheet_ui_row_tip"
                         ng-if="
                             s.sheet.weapon_proficiency_type == undefined &&
                             user.user.preferences.show_ui_tips
                         "
                     >
                         Use the controls on the <b>Survivor Sheet</b>
                         to set the Weapon Proficiency type 
                         for {{s.sheet.name}}.
                     </div>

                     <div class="kd_sheet_ui_number_tumbler">
                         <button
                             class="kd_kickstarter_button"
                             ng-click="s.sheet['Weapon Proficiency'] = s.sheet['Weapon Proficiency'] + 1"
                         >
                             &#x25B2;
                         </button>
                         <button
                             class="kd_kickstarter_button"
                             ng-click="s.sheet['Weapon Proficiency'] = s.sheet['Weapon Proficiency'] - 1"
                         >
                             &#x25BC;
                         </button>
                         <button
                             class="kd_kickstarter_button kd_blue"
                             ng-click="setSurvivorAttribute(s, 'Weapon Proficiency'); rollUp(weaponProficiencyBoxID)"
                         >
                             Save Changes
                         </button>
                     </div> <!-- number tumbler -->
                 </div>
             </div>
            <!-- weapon proficiency -->


            <!-- Courage -->
            <div
                class="quickview_secondary_container courage clickable border_box"
                ng-click="rollUp(courageBoxID)"
            >
                Courage
                <div class="secondary_attrib_row_container">
                    <div
                        class="secondary_attrib_box_row courage"
                        ng-init="courageBoxes = [1,2,3,4,5,6,7,8,9]"
                    >
                        <div
                            class="kd_sheet_ui_box"
                            ng-repeat = "b in courageBoxes"
                            ng-class="{
                                checked: s.sheet.Courage >= b,
                                heavy: [3,9].indexOf(b) != -1,
                            }"
                        >
                        </div>
                    </div>
                </div> <!-- row_container -->
                <div
                    class="kd_sheet_ui_row_tip"
                    ng-if="s.sheet.abilities_and_impairments.indexOf('stalwart') != -1"
                >
                    <b>Stalwart:</b>
                    {{settlement.game_assets.abilities_and_impairments.stalwart.summary}}
                </div>
                <div
                    class="kd_sheet_ui_row_tip"
                    ng-if="s.sheet.abilities_and_impairments.indexOf('prepared') != -1"
                >
                    <b>Prepared:</b>
                    {{settlement.game_assets.abilities_and_impairments.prepared.summary}}
                </div>
                <div
                    class="kd_sheet_ui_row_tip"
                    ng-if="s.sheet.abilities_and_impairments.indexOf('matchmaker') != -1"
                >
                    <b>Matchmaker:</b>
                    {{settlement.game_assets.abilities_and_impairments.matchmaker.summary}}
                </div>
            </div>
            <div
                id="{{courageBoxID}}"
                class="kd_sheet_ui_roll_down rolled_up"
            >
                <div class="kd_sheet_ui_roll_down_controls">
                    <div class="kd_sheet_ui_number_tumbler">
                        <button
                            class="kd_kickstarter_button"
                            ng-click="s.sheet.Courage = s.sheet.Courage + 1"
                        >
                            &#x25B2;
                        </button>
                        <button
                            class="kd_kickstarter_button"
                            ng-click="s.sheet.Courage = s.sheet.Courage - 1"
                        >
                            &#x25BC;
                        </button>
                        <button
                            class="kd_kickstarter_button kd_blue"
                            ng-click="
                                setSurvivorAttribute(s, 'Courage');
                                rollUp(courageBoxID)
                            "
                        >
                            Save Courage
                        </button>
                    </div> <!-- number tumbler -->
                </div>
            </div>
            <!-- courage -->


            <!-- Understanding -->
            <div
                class="quickview_secondary_container understanding clickable border_box"
                ng-click="rollUp(understandingBoxID)"
            >
                Understanding
                <div class="secondary_attrib_row_container">
                    <div
                        class="secondary_attrib_box_row understanding"
                        ng-init="understandingBoxes = [1,2,3,4,5,6,7,8,9]"
                    >
                        <div
                            class="kd_sheet_ui_box"
                            ng-repeat = "b in understandingBoxes"
                            ng-class="{
                                checked: s.sheet.Understanding >= b,
                                heavy: [3,9].indexOf(b) != -1,
                            }"
                        >
                        </div>
                    </div>
                </div><!-- secondary_Attrib_row_container -->
                <div class="kd_sheet_ui_row_tip" ng-if="s.sheet.abilities_and_impairments.indexOf('analyze') != -1">
                    <b>Analyze:</b> {{settlement.game_assets.abilities_and_impairments.analyze.summary}}
                </div>
                <div class="kd_sheet_ui_row_tip" ng-if="s.sheet.abilities_and_impairments.indexOf('explore') != -1">
                    <b>Explore:</b> {{settlement.game_assets.abilities_and_impairments.explore.summary}}
                </div>
                <div
                    class="kd_sheet_ui_row_tip"
                    ng-if="s.sheet.abilities_and_impairments.indexOf('tinker') != -1"
                >
                    <b>Tinker:</b> {{settlement.game_assets.abilities_and_impairments.tinker.summary}}
                </div>
            </div>
            <div
                id="{{understandingBoxID}}"
                class="kd_sheet_ui_roll_down rolled_up"
            >
                <div class="kd_sheet_ui_roll_down_controls">
                    <div class="kd_sheet_ui_number_tumbler">
                        <button
                            class="kd_kickstarter_button"
                            ng-click="s.sheet.Understanding = s.sheet.Understanding + 1"
                        >
                            &#x25B2;
                        </button>
                        <button
                            class="kd_kickstarter_button"
                            ng-click="s.sheet.Understanding = s.sheet.Understanding - 1"
                        >
                            &#x25BC;
                        </button>
                        <button
                            class="kd_kickstarter_button kd_blue"
                            ng-click="setSurvivorAttribute(s, 'Understanding'); rollUp(understandingBoxID)"
                        >
                            Save Understanding
                        </button>
                    </div> <!-- number tumbler -->
                </div>
            </div>
            <!-- understanding -->


            <!-- SWORD OATH - Echoes of Death 3-->
            <div
                ng-if="s.sheet.fighting_arts.indexOf('sword_oath') !== -1"
                ng-init="swordOathControls = s._id.$oid + 'SwordOathControls'"
                class="quickview_secondary_container"
            >
                <div
                    class="clickable secondary_attribute_title_bar"
                    ng-click="rollUp(swordOathControls)"
                >
                    Sword Oath
                    <div
                        class="subtitle"
                        ng-if="s.sheet.sword_oath.sword"
                    > 
                        : <b>
                            {{settlement.game_assets.gear[s.sheet.sword_oath.sword].name}}
                        </b>
                        ({{s.sheet.sword_oath.wounds}})
                    </div>
                </div>

                <div class="kd worksheet_row checkbox_container">
                    <div
                        ng-repeat="block in range(s.sheet.sword_oath.wounds)"
                        ng-class="{
                            'red': block >= 17,
                        }"
                        class="kd checkbox checked"
                    > 
                    </div>
                </div> <!-- worksheet_row -->

                <div
                    id='{{swordOathControls}}'
                    class="kd_sheet_ui_roll_down rolled_up"
                >
                    <div class="kd_sheet_ui_roll_down_controls">
                        <div class="kd_sheet_ui_number_tumbler">
                            <select
                                class="kd_kickstarter_select"
                                ng-change="s.sheet.sword_oath.wounds = 0"
                                ng-model="s.sheet.sword_oath.sword"
                                ng-options='gear.handle as gear.name for gear in settlement.game_assets.gear| hasKeyword:"sword"'
                            >
                                <option value="" disabled selected>
                                    Select Sword
                                </option>
                            </select>
                            <button
                                ng-if="s.sheet.sword_oath.sword"
                                class="ng_fade kd_kickstarter_button"
                                ng-click="s.sheet.sword_oath.wounds = s.sheet.sword_oath.wounds + 1"
                            >
                                &#x25B2;
                            </button>
                            <button
                                class="ng_fade kd_kickstarter_button"
                                ng-if="s.sheet.sword_oath.sword"
                                ng-disabled="s.sheet.sword_oath.wounds === 0"
                                ng-click="s.sheet.sword_oath.wounds = s.sheet.sword_oath.wounds - 1"
                            >
                                &#x25BC;
                            </button>
                            <button
                                class="kd_kickstarter_button kd_blue"
                                ng-click="
                                    setSwordOath(s);
                                    rollUp(swordOathControls)
                                "
                            >
                                Save Changes
                            </button>
                        </div> <!-- number tumbler -->
                    </div>
                </div><!-- roll down controls for Sword Oath -->

            </div>

            <!-- Fighting Arts -->
            <div
                class="quickview_secondary_container fighting_arts"
            >
                <div class="secondary_attribute_title_bar">
                    <div class="font_large title">Fighting Arts</div>
                    <div class="font_small subtitle">Maximum 3.</div>
                    <div
                        class="font_small lockbox clickable"
                        ng-click="toggleSurvivorFlag(s, 'cannot_use_fighting_arts')"
                    >
                        <div
                            class="kd_sheet_ui_box"
                            ng-class="{checked: s.sheet.cannot_use_fighting_arts == true}"
                        >
                        </div>
                        <span>
                            &nbsp; &#x1f512; Cannot use Fighting Arts
                        </span>
                    </div>
                </div>
                <ul class="quickview_asset_list">
                    <li
                        ng-repeat="fa in s.sheet.fighting_arts track by $index"
                        ng-class="{true: 'faded'}[s.sheet.cannot_use_fighting_arts]"
                    >
                        <b>{{settlement.game_assets.fighting_arts[fa].name}}:</b>
                        <span ng-bind-html="settlement.game_assets.fighting_arts[fa].desc|trustedHTML"></span>
                        <br/>
                    </li>
                </ul>
            </div>
            <!-- fighting arts -->


            <!-- Disorders -->
            <div
                class="quickview_secondary_container disorders"
            >
                <div class="secondary_attribute_title_bar">
                    <div class="font_large title">Disorders</div>
                    <div class="font_small subtitle">Maximum 3.</div>
                </div>
                <ul class="quickview_asset_list">
                    <li
                        ng-repeat="d in s.sheet.disorders"
                    >
                        <b>{{settlement.game_assets.disorders[d].name}}:</b>
                        <span ng-bind-html="settlement.game_assets.disorders[d].survivor_effect|trustedHTML">
                        </span>
                    </li>
                </ul>
            </div>
            <!-- disorders -->


            <!-- A&I -->
            <div
                class="quickview_secondary_container fighting_arts"
            >
                <div class="secondary_attribute_title_bar">
                    <div class="font_large title">Abilities & Impairments</div>
                    <div
                        class="font_small lockbox clickable skip_next_hunt"
                        ng-click="toggleSurvivorFlag(s, 'skip_next_hunt')"
                    >
                        <div
                            class="kd_sheet_ui_box"
                            ng-class="{checked: s.sheet.skip_next_hunt == true}"
                        >
                        </div>
                        <span>
                            &nbsp; &#x1f512; Skip Next Hunt
                        </span>
                    </div>
                </div>
                <ul class="quickview_asset_list">
                    <li
                        ng-repeat="ai in s.sheet.abilities_and_impairments track by $index"
                    >
                        <b>{{settlement.game_assets.abilities_and_impairments[ai].name}}:</b>
                        <span ng-bind-html="settlement.game_assets.abilities_and_impairments[ai].desc|trustedHTML"></span>
                        <br/>
                    </li>
                </ul>
            </div>
            <!-- AI -->

        </div><!-- right column -->

    </div><!-- columns -->

        <div class="quickview_ui_button_container">
        <!-- there are various controls here, so they're all wrapped in a div, 
        so that we can control how much space they take up w/o writing a bunch 
        of super-specific selectors. -->

            <div>
                <form action="" method="POST" class="edit_survivor_sheet">
                    <input type="hidden" name="view_survivor" value="{{s.sheet._id.$oid}}" />
                    <button
                        class="quickview_ui_button kd_kickstarter_button settlement_sheet_gradient"
                        ng-click="
                            showFullPageLoader();
                            ngShowHide(s.sheet._id.$oid + '_modal_controls');
                        "
                    >
                        Edit <b>Survivor Sheet</b>
                    </button>
                </form>
            </div>

            <div>
                <select
                    class="kd_kickstarter_select"
                    ng-disabled="user.user.subscriber.level < 1"
                    ng-model="s.sheet.color_scheme"
                    ng-change="setColorScheme(s);"
                    ng-options="c.handle as c.name for c in settlement.survivor_color_schemes"
                >
                    <option disabled value="">Set Color Scheme</option>
                </select>
            </div>
            <div
                ng-if="
                    group.handle == 'available' ||
                    group.handle == 'favorite' ||
                    group.handle == 'departing'
                "
            >
                <button
                   ng-if="s.sheet.departing == true"
                   ng-click="
                       toggleDepartingStatus(s);
                       ngShowHide(s.sheet._id.$oid + '_modal_controls');
                   "
                   class="quickview_ui_button kd_kickstarter_button kd_red"
                >
                    Leave <b>Departing</b> Survivors
                </button>
                <button
                    ng-if="s.sheet.departing != true"
                    ng-click="
                        toggleDepartingStatus(s);
                        ngShowHide(s.sheet._id.$oid + '_modal_controls');
                    "
                    class="quickview_ui_button kd_kickstarter_button kd_red"
                >
                    Join <b>Departing</b> Survivors
                </button>
            </div> <!-- conditional departing toggle -->
            <div>
                <button
                    class="quickview_ui_button kd_kickstarter_button"
                    ng-click="ngHide(survivorQuickviewControllerId)"
                >
                    Back
                </button>
            </div>
        </div> <!-- kd_sheet_ui_innter_ring_container -->
    </div> <!-- kd_sheet_ui_outer_ring_container-->
</div> <!-- quick view modal -->


                        </div>
                        </div> <!-- survivor container -->

                    </div><!-- show/hide container -->
                </div> <!-- survivors_group -->

        </div> <!-- campaign_summary_survivors_container -->

    </div> <!--campaign_summary_left_panel -->


    <!-- campaign summary RIGHT panel BEGINS -->

    <div class="campaign_summary_right_panel" ng-if="settlement != undefined">

        <div
            ng-if="departing_survivor_count > 0"
            class="ng_fade manage_departing_survivors_blocker"
        >

        </div>

        <div
            ng-repeat="r in settlement.campaign.special_rules"
            class="campaign_summary_special_rule"
            style="background-color: #{{r.bg_color}}; color: #{{r.font_color}}"
        >
            <h3>{{r.name}}</h3>
            <span ng-bind-html="r.desc|trustedHTML"></span>
        </div>


        <!--

            pulse discoveries!

        -->

        <div
            class="campaign_summary_small_box"
            ng-if="settlement.sheet.lantern_research_level >= 1"
        >
            <h3 class="kd_title"> Pulse Discoveries </h3>
            <div class="pulse_discoveries_container">
                <div
                    class="pulse_discovery"
                    ng-repeat="d in settlement.game_assets.pulse_discoveries"
                    ng-if="settlement.sheet.lantern_research_level >= d.level"
                    style="background-color: {{d.bgcolor}}"
                >
                    <div class="pd_level_container">
                        <div class="pd_level">{{d.level}}</div>
                    </div>
                    <div class="pd_text">
                        <b>{{d.name}}</b>
                        <span ng-if="d.subtitle != undefined"> - {{d.subtitle}}</span>
                        <br/>
                        {{d.desc}}
                    </div>
                    <div
                        ng-if="d.level !== settlement.sheet.lantern_research_level"
                        class="pd_arrow"
                        style="color: {{d.bgcolor}}"
                    >
                        <div class="glyph">&#129067;</div>
                    </div>
                </div><!-- repeater -->
            </div><!-- container -->
        </div> <!-- pulse discoveries -->


        <!--

            endeavor tokens!

        -->

        <div
            ng-if="
                user_is_settlement_admin &&
                user.user.preferences.show_endeavor_token_controls != false &&
                settlement.sheet.lantern_year > 0
            "
            class="campaign_summary_small_box"
        >
            <div
                title="Manage settlement Endeavor tokens here! Settlement admins may use the controls at the right to increment or decrement the total number of tokens!"
                class="campaign_summary_endeavor_controller"
                ng-controller="endeavorController"
            >

                <div ng-if="settlement.sheet.endeavor_tokens >= 1">

                    <div class="tokens">
                        <img
                            ng-repeat="e in range(settlement.sheet.endeavor_tokens)"
                            class="campaign_summary_endeavor_star"
                            src="/media/icons/endeavor_star.png"
                        />
                    </div>

                    <div
                        ng-if="user_is_settlement_admin"
                        class="settlement_sheet_tumbler_control_raft"
                    >
                        <button ng-click="rmToken()" > &#9662; </button>
                        <button ng-click="addToken()" > &#9652; </button>
                    </div>

                </div>

                <div
                    ng-if="settlement.sheet.endeavor_tokens <= 0"
                    ng-click="addToken()"
                    class="endeavor_controls_toggle settlement_sheet_block_group clickable"
                >
                    <h3>- Endeavor Tokens -</h3>
                    <div
     	                class="ng_fade kd_sheet_ui_row_tip"
                     	ng-if="user.user.preferences.show_ui_tips"
     	            >
                        <p>Click or tap here to manage Endeavor Tokens.</p>
                    </div>
                </div>

            </div> <!-- endeavor controller applet! -->

        </div> <!-- show_endeavor_controls campaign_summary_small_box -->


        <!--

            Settlement endeavor bars!   This is a repeater with custom headers

        -->

        <div
            class="campaign_summary_small_box endeavor_box"
            ng-if="settlement.campaign.endeavor_count > 0"
        >

            <h3 class="kd_title">Available Endeavors ({{settlement.campaign.endeavor_count}})</h3>

            <!--

                some weird shit goes into keeping this DRY. At the outermost
                layer, we iterate over endeavor types ('endeavorType'); those
                keys are also keys in the settlement.campaign.endeavors dict.

                The values in that dict are lists of handles, which we then
                iterate, expanding them into endeavor dictionaries as we go.

                As we're expanding each dict, we have h4's for each
                possible type (i.e. the first thing we're iterating) that we
                show if the endeavor is that type.

                Our "fuck you, Poots" exception here is when we're doing the
                'survivors' type endeavors, where the 'endeavor' dict we would
                expand is actually a survivor dict, so we can tell the user
                which survivor has the ability to trigger the endeavor.

                See app.models.settlements.py (the get_available_endeavors() 
                method, specifically) int he API for more.

            -->

            <!-- generic endeavor type repeater -->
            <div
                class="campaign_summary_endeavor_container_repeater"
                ng-repeat="endeavorType in [
                    'campaign',
                    'innovations',
                    'locations',
                    'survivors',
                    'storage',
                    'settlement_events'
                ]"
            >
                <div
                    class="campaign_summary_endeavor_location_repeater"
                    ng-repeat="i in settlement.campaign.endeavors[endeavorType]"
                >

                    <h4
                        class="font_large endeavor_location"
                        ng-if="
                            endeavorType === 'campaign' ||
                            endeavorType === 'settlementEvents'
                        "
                    >
                        <b>{{i['name']}}</b>:
                    </h4>

                    <h4
                        class="endeavor_location"
                        ng-if="endeavorType === 'innovations'"
                    >
                        <b>{{settlement.game_assets.innovations[i['handle']].name}}</b>
                        ({{settlement.game_assets.innovations[i['handle']].innovation_type}}):
                    </45>

                    <h4
                        class="endeavor_location"
                        ng-if="endeavorType === 'locations'"
                    >
                        <b>{{settlement.game_assets[endeavorType][i['handle']].name}}</b>:
                    </h4>

                    <h4
                        class="endeavor_location"
                        ng-if="endeavorType === 'survivors'"
                    >
                        <b>{{i.sheet.name}} [{{i.sheet.effective_sex}}]</b>:
                    </45>

                    <h4
                        class="endeavor_location"
                        ng-if="endeavorType === 'storage'"
                    >
                        <b>{{i.name}} ({{i.type}})</b>:
                    </h4>

                    <!-- actual endeavor bar starts here -->
                    <div
                        ng-repeat="e_handle in i.endeavors"
                        ng-init="e = settlement.game_assets.endeavors[e_handle]"
                        class="campaign_summary_endeavor_container {{e.class}}"
                    >
                        <div class="endeavor_cost {{e.class}} kdm_font_10">
                            <span ng-repeat="c in range(e.cost)">d</span>
                        </div>

                        <div class="endeavor_text">
                            <b ng-if="e.name != undefined">{{e.name}}</b>
                            <span ng-if="e.name != undefined && e.desc != undefined"> - </span>
                            <span ng-bind-html="e.desc|trustedHTML"></span>
                        </div>

                        <div
                            ng-if="e.cost_detail != undefined"
                            class="cost_detail {{e.cost_detail_type}}_cost_detail"
                        >
                            <div ng-repeat="i in e.cost_detail">
                                {{i}}
                            </div>
                        </div>

                    </div> <!-- endeavor bar -->

                </div> <!--  endeavor location/source repeater -->

            </div><!-- endeavor_bar_repeater -->

        </div>  <!-- campaign_summary_small_box endeavor_box -->


        <!-- principles, innovations, locations boxes -->
        <div
            class="clickable"
            ng-repeat="(location, lookup) in {
                'principles': 'innovations',
                'innovations': 'innovations',
                'locations': 'locations',
            }"
            ng-init="
                uiID = location + 'ShowBonuses';
                ngVisible[uiID] = false
            "
            ng-click="ngVisible[uiID] = !ngVisible[uiID]"
            title="Tap or click to see descriptions!"
        >
            <div
                class="campaign_summary_small_box settlement_fact"
                ng-if="settlement.sheet[location].length >= 1"
            >

                <h3 class="kd_title">{{location}}</h3>

                <div
                    ng-repeat="p in settlement.sheet[location]"
                >

                    <span
                        class="kd_checkbox_checked campaign_summary_bullet"
                        ng-init="object = settlement.game_assets[lookup][p]"
                    >
                        {{object.name}}
                        <span
                            ng-if="object.levels !== undefined"
                            ng-init="lookup_dict = location.slice(0, -1) + '_levels'"
                        >
                            (Lvl.
                                {{settlement.sheet[lookup_dict][p]}})
                        </span>
                    </span>
    
                    <div
                        class="campaign_summary_settlement_bonus_desc"
                        ng-bind-html="object.desc|trustedHTML"
                        ng-if="
                            object.desc !== undefined &&
                            ngVisible[uiID]
                        "
                    ></div>

                </div>

            </div>

        </div> <!-- repeater -->


        <!-- monsters summary box -->

        <div
            class="campaign_summary_small_box settlement_fact"
            ng-if="settlement.sheet.lantern_year > 0"
        >
            <h3 class="kd_title">Monsters</h3>

            <h4 class="monster_subhead" ng-if="settlement.sheet.monster_volumes.length >= 1">
                Monster Volumes
            </h4>
            <span
                class="kd_checkbox_checked campaign_summary_bullet"
                ng-repeat='v in settlement.sheet.monster_volumes'
            >
                {{v}}
            </span>

            <h4 class="monster_subhead" ng-if="settlement.sheet.defeated_monsters.length >=1">
                Defeated Monsters
            </h4>
            <span
                class="kd_checkbox_checked campaign_summary_bullet"
                ng-repeat="d in settlement.sheet.defeated_monsters track by $index"
            >
                {{d}}
            </span>

            <h4 class="monster_subhead">Quarries </h4>
            <span
                class="kd_checkbox_checked campaign_summary_bullet"
                ng-repeat="n in settlement.sheet.quarries"
            >
                {{ settlement.game_assets.monsters[n].name }}
            </span>

            <h4 class="monster_subhead">Nemesis Monsters</h4>
            <span
                class="kd_checkbox_checked campaign_summary_bullet"
                ng-repeat="n in settlement.sheet.nemesis_monsters"
            >
                {{ settlement.game_assets.monsters[n].name }}
            </span>

        </div> <!-- monsters box-->

    </div> <!-- campaign summary RIGHT PANEL ENDS HERE -->

</div> <!-- campaign_summary_panels_container -->


<!-- launcher button for managing departing survivors! -->

<button
    id="manageDepartingSurvivors"
    class="ng_fade kd_kickstarter_button kd_red"
    ng-if="departing_survivor_count > 0"
    ng-click="ngShow('departingSurvivorsModalContent')"
>
    Manage {{departing_survivor_count}} <b>Departing</b> Survivors
</button>




<!--

        THE FOLD!

    This is 'the fold'. The only content below here should be modals, etc.
    that don't need to load or be visible right away on page load.

-->

<div
    id="campaignSummaryStorageOpener"
    class="ng_fade clickable font_large campaign_summary_storage_opener gradient_silver"
    ng-if="settlementStorage != undefined && settlement.sheet.storage.length > 0 "
    ng-click="openNav('campaignSummaryStorageModal')"
>
    &#8942;
</div>

    <div
        id="campaignSummaryStorageModal"
        class="rightSideNav dying_lantern clickable"
        ng-if="
            settlement !== undefined &&
            user.user.subscriber.level >= 2
        "
        ng-init="getStorage()"
        ng-click="closeNav('campaignSummaryStorageModal')"
    >
        <div
            class="rightSideNavContent"
        >
            <div
                class="campaign_summary_storage_type"
                ng-repeat="s_type in settlementStorage">
            
                <h3 class="kd_title">{{s_type.name}} Storage</h3>
                <div class="campaign_summary_storage_keywords">
                    <span
                        class="campaign_summary_storage_keyword"
                        ng-repeat="(kw, count) in s_type.keywords"
                    >
                        {{kw}}: {{count}}
                    </span>
                </div>

                <div
                    class="campaign_summary_storage_location"
                    ng-repeat="loc in s_type.locations"
                    ng-if="loc.inventory.length >= 1"
                >
                    <h4>{{loc.name}}</h4>
                    <div class="campaign_summary_storage_items">
                        <span
                            class="campaign_summary_storage_item"
                            ng-repeat="i in loc.collection"
                            ng-if="i.quantity >= 1"
                        >
                            {{i.name}}
                            <span
                                ng-if="i.quantity >= 2"
                            >
                                x {{i.quantity}}
                            </span>
                            <br/>
                            <div
                                class="campaign_summary_storage_item_keywords"
                                ng-if="i.keywords.length >= 1"
                            >
                                <i>{{i.keywords.join(', ')}}</i>
                            </div>
                            <div
                                class="campaign_summary_storage_item_keywords"
                                ng-if="i.rules.length >= 1"
                            >
                                <b>{{i.rules.join(', ')}}</b>
                            </div>
                        </span>
                    </div>
                </div> <!-- location -->

                {{loc}}

            </div>
        </div> <!-- rightSideNavContent -->

        <div class="right_side_nav_close_tip">Click or tap to close!</div>

    </div>

</div> <!-- campaign_summary main root controller THIS IS THE END -->

